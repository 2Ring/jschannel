<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title> JSChannel Tests </title>

<script type="text/javascript" src="doctestjs/doctest.js"></script>
<link rel="stylesheet" type="text/css" href="doctestjs/doctest.css">
<script type="text/javascript" src="../src/jschannel.js"></script>

<style type="text/css">
body {
    font-family: "Helvetica,Arial,FreeSans";
}
#container {
  margin: 0 auto;
  width: 900px;
}
h1 { font-size: 3.8em; margin-bottom: 3px; }
h1 .small { font-size: 0.4em; }
h1 a { text-decoration: none }
h2 { font-size: 1.5em;  }
    h3 { text-align: center; }
    .description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
    .download { float: right; }
pre { background: #000;  color: #FFFFFF; padding: 15px;}
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .footer { text-align:center; padding-top:30px; font-style: italic; }
</style>

</head>
<body>
<iframe style="display: none;" id="childId" src="index_child.html"></iframe>
<iframe style="display: none;" id="fakeChildId"></iframe>
<div id="container">
<h1> JSChannel testing </h1>

<p>
What follows are a pile of tests for JSChannel.  Simply click the test
button at the bottom to run them.  This page uses
the <a href="http://ianb.github.com/doctestjs/">doctestjs</a> library
by Ian Bicking.
</p>
<p>
<button onclick="doctest()">run all tests</button>
<pre id="doctestOutput"></pre>
</p>

<h2>Testing Constructor invocation</h2>

Test passing a bogus first parameter to .build()
<pre class="doctest">
$ Channel.build();
Error: Channel.build() called without a valid window argument
$ Channel.build(document.getElementById("fakeChildId"));
Error: Channel.build() called without a valid window argument
</pre>

Now how about the second, origin parameter:
<pre class="doctest">
$ var tgtwin = document.getElementById("fakeChildId").contentWindow;
$ Channel.build(tgtwin, "this isn't a valid origin!");
Error: Channel.build() called with an invalid origin
$ Channel.build(tgtwin, "http://trickyco.de");
$ Channel.build(tgtwin, "http://trickyco.de:8080");
$ Channel.build(tgtwin, "http://trickyco.de:8080/");
Error: Channel.build() called with an invalid origin
$ Channel.build(tgtwin, "http://localhost");
$ Channel.build(tgtwin, "http://localhost:1234");
$ Channel.build(tgtwin, "http://10.0.1.104:1234");
</pre>

Final param, scope?
<pre class="doctest">
$ var tgtwin = document.getElementById("fakeChildId").contentWindow;
$ Channel.build(tgtwin, "http://trickyco.de", "goodScope");
$ Channel.build(tgtwin, "http://trickyco.de", "speshulScope!@#%^@**(#(%*<>';][,.';'");
$ Channel.build(tgtwin, "http://trickyco.de", "closeTo:BadScope");
$ Channel.build(tgtwin, "http://trickyco.de", "closer:T:o:B:a:dScope");
$ var chan = Channel.build(tgtwin, "http://trickyco.de", "veryBad::Scope");
Error: scope may not contain double colons: '::'
</pre>

<h2>query/response</h2>

<script>
// allocate a single global channel that we'll run all our tests in
chan = Channel.build(document.getElementById("childId").contentWindow, "*", "testScope");
</script>

Test basic query/response:
<pre class="doctest">
$ var spy1 = Spy('spy1', {writes: true});
$ chan.query({
>   method: "reverse",
>   params: "hello world!",
>   success: function(v) {
>       spy1.func(v.toString());
>   }
> });
$ spy1.wait();
Spy('spy1').spy1("!dlrow olleh")
</pre>

Test all flavors of error responses
<pre class="doctest">
$ var spy2 = Spy('spy2', {writes: true});
$ var sf = function (r) { spy2.func(r) }; // not hit in this block!
$ var ef = function (code, message) { spy2.func(code, message); };
$ chan.query({method: "error", error: ef, success: sf}); spy2.wait();
Spy('spy2').spy2("parameter_required", "you're missing the 'type of error to emit' parameter, doofus")
$ chan.query({method: "error", params: "throw_array", error: ef, success: sf}); spy2.wait();
Spy('spy2').spy2("array_error_code", "array error message")
$ chan.query({method: "error", params: "throw_object", error: ef, success: sf}); spy2.wait();
Spy('spy2').spy2("object_error_code", "object error message")
$ chan.query({method: "error", params: "throw_string", error: ef, success: sf}); spy2.wait();
Spy('spy2').spy2("runtime_error", "this is a string")
$ chan.query({method: "error", params: "accidental_throw", error: ef, success: sf}); spy2.wait(); // exception content varies by browser
Spy('spy2').spy2("runtime_error", ...)
$ chan.query({method: "error", params: "smush_object", error: ef, success: sf}); spy2.wait(); // thrown objects get smushed.
Spy('spy2').spy2("runtime_error", "{\"dont\":\"smush\",\"me\":\"no!!\"}")
$ chan.query({method: "error", params: "tostring_craziness", error: ef, success: sf}); spy2.wait(); // if JSON.stringify pukes, toString()
Spy('spy2').spy2("runtime_error", "[object ...]")
</pre>

<h2>callbacks</h2>
<pre class="doctest">
$ var spy3 = Spy('spy3', {writes: true});
$ var dummyf = function (r) { };
$ var sf = function (r) { spy3.func(r) };
$ var ef = function (code, message) { spy3.func(code, message); };
$ chan.query({method: "caller_backer", params: { cb: sf }, success: dummyf}); spy3.wait();
Spy('spy3').spy3("you called?")
$ chan.query({method: "caller_backer", params: { cb2: sf }, success: dummyf}); spy3.wait();
Spy('spy3').spy3("you called again!?")
$ chan.query({method: "caller_backer", params: { nested: { cb: sf } }, success: dummyf}); spy3.wait();
Spy('spy3').spy3("STOP CALLING ME!")
$ chan.query({method: "caller_backer", params: { cb: dummyf }, error: ef, success: sf}); spy3.wait();
Spy('spy3').spy3("complete")
</pre>
</div>
</body>
</html>
